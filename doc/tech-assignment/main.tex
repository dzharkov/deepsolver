
\section{Общие требования}

Система для~управления \EN{rpm}-пакетами должна состоять из~нескольких отдельных утилит,
набор которых детально описывается в~последующих главах.
При~этом существует ряд общих требований, предъявляемых к~любому приложению из~всего множества.
Ниже приводится их~подробный перечень.

\begin{description}

\item[Поддержка протоколирования.]
Любая операция, приводящая к~изменению состояния системы, 
должна поддерживать развёрнутое протоколирование всех совершаемых  действий.
Накапливаемый журнал необходимо снабжать как пометками, облегчающими чтение и поиск данных системным администратором,
так и машинночитаемой информацией с~целью обеспечения автоматизированной возможности 
возврата ОС к~предыдущему состоянию в~случае неудачного завершения транзакции. 
Записи должны разделяться по~степени критичности содержания 
(уровни ``отладка'', ``основная информация'', ``ошибка'', ``критическая ошибка'').
Для~всех утилит требуется наличие ключа \CODE{--verbose},
 повышающего детальность информации,
выводимой на~стандартный поток вывода.

\item[Исключение возможности злоумышленного подмена данных.]
Конечный пользователь всей системы должен иметь возможность удостовериться, что множество пакетов для~установки в~ОС и 
вспомогательная для~них информация предоставлены доверенным лицом.
Контроль аутентичности необходимо выполнять на~основе цифровой подписи   автора  автоматически  во~время работы.
При~обнаружении признаков атаки требуется уведомить об~этом пользователя и добавить соответствующую информацию в~журнал.
Уведомление должно указывать, обнаружено~ли только несовпадение контрольной суммы (возможное случайное повреждение, например, при~передаче по~сети)
или найдена недействительная цифровая подпись при~корректной контрольной сумме (явно злоумышленный характер искажений).

\item[Минимизация риска аварийного завершения операции.]
При~любой операции, предполагающей внесенеи изменений в~состояние ОС, необходимо предварительно 
провести максимально доступное количество проверок с~целью предотвращения неуспешного результата работы.
Начало модификации системы допускается только в~случае, если все~необходимые данные доставлены на~локальный компьютер,
проверена их~целостность, устранена возможность файловых конфликтов (см.~гл.~\ref{pkgstruct}), и доступно достаточное количество свободного дискового пространства.

\item[Поддержка параллельных вычислений.]
Все~операции, предполагающие высокую вычислительную нагрузку на~процессор,
по~мере возможности должны поддерживать параллельный режим работы.
Разделение общей задачи на~несколько процессов или потоков позволит задействовать несколько ядер в~многоядерных системах,
что способно значительно ускорить получение результата. 
Желательно, чтобы количество процессов или потоков в~вычислении не~превышало физическое количество ядер системы.
Это требование не~распространяется на~процедуру загрузки данных по~сети.

\item[Кэширование данных из~удалённых источников]
При~загрузке пакетов для~установки из~удалённых репозиториев в~сети
полученные файлы должны сохраняться в~специально отведённой системной директории на~случай повторного использования.
При~этом требуется наличие конфигурационного параметра, задающего максимальной размер директории для~хранения.
При~превышении заданного порога размера кэша пакеты необходимо удалять с~учётом давности последнего обращения.

\end{description}

\section{Основные операции}
\subsection{Операция установки и обновления пакетов}

Операции установки и обновления пакетов имеют единый интерфейс пользователя.
В~качестве основного параметра указывается множество пакетов, каждый из~которых может быть  задан одним из~следующих способов:

\begin{itemize}
\item {по~имени;}
\item {по~имени с~ограничением версии, включая возможность даунгрейда;}
\item {по~ссылке на~файл пакета, включая возможность загрузки из~сети;}
\item{по~одному из \EN{provides} пакета (см.~гл.~\ref{pkgstruct}), включая возможность указания ограничения версии.}
\end{itemize}

При~указании более одного пакета операция отменяется полностью для~\underline{всех} пакетов, 
если обнаружена проблема установки хотя~бы одного из~них.
При~вызове операции необходимо наличие возможности запрета пользователем рассмотрения решений, 
включающих установку некоторого пакета. 
Предполагается, что два~пакета с~одинаковыми именами, эпохами, версиями и релизами являются одним и~тем~же пакетом,
и не~имеет значения, какой из~них будет выбран для~установки.
Только в~случае указания точной версии или имени файла происходит однозначный выбор пакета для~установки.

При~отсутствия ограничений версии возможна замена имени устанавливаемого пакета,  
Если обнаружен  пакет, содержащий запись \EN{obsoletes}, под~которую попадает запрошенный пакет.
Порядок выбора замены должен быть следующим:

\begin{enumerate}

\item {
Если указанный пакет не~установлен, а~все записи \EN{obsoletes} содержат неподходящие ограничения версии для~самого свежего его~варианта в~подключенных репозиториях,
то устанавливается именно указанный пакет по~схеме, описанной ниже.
}

\item {
Если указанный пакет не~установлен, и есть запись \EN{obsoletes} без~указанием версии или с~ограничением, подходящим под~самый свежий вариант запрошенного пакета,
то устанавливается пакет с~найденной записью \EN{obsoletes}.
Правила, описанные ниже при~этом не~используются.
Если таких пакетов несколько, то выбор среди них не~определён.
}

\item {
Если пакет установлен, и обнаружен пакет с~подходящей записью версии (версия подходит или не~указана),
то устанавливается пакет с~записью \EN{obsoletes}.
Правила, описанные ниже, не~используются.
Если таких пакетов несколько, то выбор среди них не~определён.
}

\end{enumerate}

В~случае не~указания пользователем версии или указания множества допустимых версий (не~новее заданной или не~старше заданной)
пакет для~установки должен определяться следующим образом:

\begin{enumerate}

\item{
Если существует пакет, имя которого соответствует заданному, ему отдаётся приоритет.
Существующие пакеты, содержащие одноимённые \EN{provides}, не~рассматриваются.
}

\item {
Если указанному имени соответствуют только \EN{provides} других пакетов,
то приоритет определяется на~основе предустановленных предпочтений (см.~гл.~\ref{advfeatures}).
Варианты вне~списка предпочтений используются только в~случае невозможности установки приоритетного пакета (без~запроса пользователю).
При~отсутствии указания приоритета разрешения \EN{provides} порядок выбора не~определён.
}

\item {
При~наличии нескольких версий пакета приоритет отдаётся самой старшей.
В~случае невозможности её~установки производится выбор наиболее свежей версии, приводящей к~возможному решению, с~запросом подтверждения пользователю (см.~ниже подробнее).
При~обновлении пакета могут рассматриваться только версии старше имеющейся.
Если пакет был отобран на~основе его~\EN{provides}, 
то версия не~анализируется\footnote{
Возможность использования версии самого пакета не~рассматривается,
поскольку один и~тот~же \EN{provides} могут иметь не~связанные между собой пакеты, сравнение версий которых бессмысленно.
Версии \EN{provides} сравнивать невозможно, поскольку они могут быть не~только конкретным значением, но и множеством значений.}
}

\end{enumerate}

При~рассмотрении множества пакетов для~разрешения \EN{provides}
анализируются \EN{provides} только с~указанной версией, если пользователь при~вызове операции наложил ограничения версии.
В~противном случае требуется рассмотрение всех \EN{provides} с~соответствующим именем.

В~случае обнаружения невозможности выбора самой старшей версии хотя~бы для~одного пакета из~указанного множества
должен производиться поиск первого допустимого решения с~перебором всех доступных версий всех указанных при~вызове пакетов,
затем пользователю необходимо предложить подтвердить установку всех пакетов, для~которых выбрана не~самая старшая версия из~доступных\footnote{
Процедура просмотра версий пакетов с~большой степенью вероятности окажется крайне ресурсоёмкой с~точки зрения нагрузки на~процессор в~силу природы решаемой задачи.
Тем~не~менее, поскольку появление в~репозиториях нескольких версий одного и того~же пакета встречается относительно редко,
на~практике существование этой функции не~должно приводить к~существенным задержкам.
}.
Если пользователь отвечает отрицательно на~хотя~бы один из~вопросов, работа приложения останавливается без рассмотрения прочих вариантов.

Механизм подбора версии используется только для~пакетов, указанных пользователем при~запуске операции,
но не~используется при~разрешений \EN{requires} (выбирается всегда самая свежая версия).
Во~всём остальном правила разрешения \EN{requires} соответствуют описанным.
Правила разрешения \EN{conflicts} подразумевают рассмотрение всех возможных пакетов и их~версий, удовлетворяющих ограничениям.

При~указании множества пакетов для~установки или обновления  допускается возможность использования регулярных выражений.
С~этой целью требуется наличие аргумента командной строки,  
разрешающего обработку ввода пользователя как~регулярного выражения,
а~также определяющего,  должны~ли регулярные выражения обрабатываться на~множестве имён пакетов или с~учётом известного списка всех \EN{provides}.
Все~обнаруженные допустимые подстановки передаются на~вход операции так, как если~бы пользователь сделал перечисление вручную.

Необходимо наличие возможности следующих вариантов выполнения операции без~изменения состояния ОС:

\begin{enumerate}

\item {
Поиск решения и вывод перечня требуемых изменений на~стандартный поток вывода,
включая возможность описания в~машинночитаемом формате.
При~указании списка пакетов для~загрузки из~сети по~желанию пользователя необходимо указывать в~выводе полные \EN{URL} к~файлам.
}

\item {
Поиск решения и выполнение доставки необходимых пакетов из~сети в~кэш или в~директорию, указанную пользователем, без~установки.
}

\end{enumerate}

В~стандартном поведении операция должна производить поиск решений с~учётом экономии дискового пространства пользователя. 
Дополнительно требуется наличие параметра командной строки, запрещающего удаление уже~установленных пакетов из~системы. 

Зависимости, указанные как необходимые только для~выполнения дополнительных скриптов установки/удаления пакета,
удовлетворяются при~работе соответствующих операций.
Установленные таким образом дополнительные пакеты после завершения внесения изменений из~ОС не~удаляются автоматически,
но могут быть удалены вручную.

\subsection{Операция удаления пакетов}

При~выполнении операции удаления указывается множество пакетов для~обработки.
Допускается использование только настоящих имён пакетов, \EN{provides} не~рассматриваются.
Операция производит изменения, после которых ни~один из~указанных пакетов не~может присутствовать в~ОС,
но допускается установка дополнительных, если это требуется зависимостями. 
Ситуация вызова операции для~отсутствующего пакета ошибочной не~считается.

Для~увеличения точности определения желаемого результата требуется возможность указания пользователем 
необходимости  присутствия в~системе некоторого пакета после окончания работы.
Требуется наличие опции командной строки, запрещающей установку новых пакетов. 
Допускается использование регулярных выражений,
которые применяются к~именам (без~учёта \EN{provides}) всех установленных пакетов.

Должны быть предусмотрены следующие варианты работы без~изменения состояния ОС:

\begin{enumerate}

\item {
Поиск решения и вывод перечня требуемых изменений на~стандартный поток вывода,
включая возможность описания в~машинночитаемом формате.
При~указании списка пакетов для~загрузки из~сети по~желанию пользователя необходимо указывать в~выводе полные \EN{URL} к~файлам.
}

\item {
Поиск решения и выполнение доставки необходимых пакетов из~сети в~кэш или в~директорию, указанную пользователем, без~установки.
}

\end{enumerate}

\subsection{Операция переустановки пакетов}

Операция переустановки одного или нескольких пакетов производится для~исправления повреждённой ОС.
В~ходе работы пакет удаляется и заново устанавливается, сохраняя версию.
При~отсутствии необходимого пакета в~кэше производится  его~загрузка из~доступных репозиториев.
Требуется наличии режима работы только для~доставки необходимого пакета в~кэш или в~директорию, указанную пользователем.

\subsection{Операция обновления ОС}

Операция обновления ОС соответствует операции обновления пакетов с~указанием множества имён всех~установленных пакетов.
Сохраняется возможность пробного запуска работы только с~выводом списка изменений на~поток стандартного вывода или с~загрузкой пакетов из~репозиториев в~сети.
В~случае обнаружения невозможности выполнения операции пользователю необходимо предоставить подробный отчёт с~описанием проблемы и предложить сделать дополнительные указания для~её~разрешения.

\subsection{Операция получения исходных текстов}

При~вызове операции получения исходных текстов пользователь должен указать имя одного пакета,
для~которого он~желает получить исходные тексты.
В~ходе работы требуется произвести в~хранимой базе данных   поиск имени пакета с~исходными текстами,
из~которого был получен указанный бинарный пакет, 
определить его~местонахождение в~имеющихся репозиториях и доставить в~директорию, указанную пользователем.
Загруженный пакет в~кэш не~помещается.

\subsection{Операция исправления целостности ОС}

Операция контроля целостности ОС должна выполнить  для~каждого пакета  проверку удовлетворения его~зависимостей и конфликтов с~другими пакетами.
Процедуру исправления найденных ошибок требуется выполнять следующим образом:

\begin{enumerate}

\item {
Для~каждой пары конфликтующих пакетов пользователю необходимо предоставить запрос для~выбора пакета для~удаления из~ОС.
}

\item {
Дополнить список пакетов для~удаления списком пакетов для~установки,
добавляя в~него все неудовлетворённые зависимости.
}

\item {
Запустить операцию  исправления ошибок, 
причём в~ходе работы должны одновременно учитываться и пакеты для~установки, и пакеты для~удаления.
В~случае невозможности нахождения решения пользователю необходимо предоставить подробное описание проблемы с~предложением установить или удалить часть пакетов вручную,
после чего повторить операцию исправления целостности.
}

\end{enumerate}

Необходимо наличие возможности выполнения операции в~информационном режиме с~выводом на~поток  стандартного вывода списка необходимых изменений,
а~также в~режиме доставки недостающих пакетов в~кэш или в~указанную пользователем директорию.

\subsection{Дополнительные возможности}
\label{advfeatures}

Требуется наличие ряда возможностей, модифицирующих поведение операций, изменяющих состояние ОС.
Они подразумевают указание пользователем дополнительной информации,
которая должна сохраняться в~конфигурационных файлах. 

\begin{description}

\item[Указание приоритетов разрешения \EN{provides}.]
Пользователь должен иметь возможность составления списка приоритетного выбора пакетов при~разрешении \EN{provides}.
Выбирается первый элемент, доступный для~установки.
В~случае ошибки оставшиеся элементы не~просматриваются,
даже если с~их~использованием существует допустимое решение\footnote{
Ограничение вызвано чрезмерной трудоёмкостью алгоритма поиска замыкания на~основе \EN{SAT~solver}.
}.

\item[Указание списка пакетов для~удержания.]
Пользователь должен иметь возможность указания списка пакетов, для~которых запрещается операция обновления.
Ни~одна из~операций, изменяющих состояние ОС, ни~может удалить или обновить пакет, указанный в~списке для~удержания,
за~исключением случаев явного перечисления пакета пользователем при~вызове операции.

\item[Указание списка ``важных'' пакетов.]
Пользователь или администратор должен иметь возможность определения списка пакетов, 
удаление которых приводит ОС в~неработоспособное состояние.
Пакеты из~указанного списка не~могут удаляться в~ходе поиска решений, а в~случае явного указания их~пользователем в~операции удаления
необходимо запросить подтверждение, что пользователь понимает риск и последствия удаления запрошенного пакета.

\end{description}

\section{Информационные операции}

Наряду с~операциями, предполагающими внесение изменений в~ОС,
необходимо наличие нескольких информационных операций,
предоставляющих различные данные по~запросу пользователя.
Все~информационные операции должны выводить результат с~учётом всех имеющихся в~репозиториях пакетов,
а~не~ограничиваться множеством установленных.

\begin{description}

\item[Вывод подробной информации о~пакете.]
Пользователь должен иметь возможность получения подробной информации о~пакете,
включающей имя, версию (эпоху, версию и релиз), архитектуру, автора (\EN{packager}), \EN{URL} проекта,
лицензию, имя пакета с~исходными текстами, однострочное и развёрнутое описание.

\item[Поиск пакета.]
Пользователь должен иметь возможность поиска пакета по~его имени (включая обработку регулярных выражений)
по~однострочному описанию и подробному описанию, указывая, какие из~перечисленных полей необходимо просматривать.

\item[Поиск пакетов, предоставляющих некоторый \EN{provides}.]
Пользователь должен иметь возможность запроса списка всех пакетов,
содержащих указанный \EN{provides}.
При~запросе ограничения версии не~указывается,
но~система выводит список подходящих пакетов с~уточнением версии соответствующего \EN{provides}.

\item[Поиск нарушений целостности множества пакетов в~репозиториях.]
Пользователь должен иметь возможность анализа содержимого подключенных репозиториев и получения списка пакетов,
установка которых невозможна по~причине отсутствия пакетов, удовлетворяющих некоторые зависимости.
Список должен содержать имя пакета и соответствующую зависимость, порождающую ошибку.

\item[Вывод бинарных пакетов на~основе пакета с~исходными текстами.]
Пользователь должен иметь возможность получения списка пакетов,
которые были созданы путём сборки указанного пакета с~исходными текстами.
Требуется возможность указания нескольких пакетов с~исходными текстами одновременно.

\item[Вывод информации о~зависимостях и конфликтах пакета.]
Пользователь должен иметь возможность просмотра информации 
о всех зависимостях и конфликтах указанного пакета, дополненной перечислением пакетов, удовлетворяющих каждому пункту выводимых данных.
Требуется явно помечать зависимости, разрешение которых невозможно удовлетворить.

\item[Вывод зависимых пакетов.]
Пользователь должен иметь возможность просмотра списка пакетов, зависимых от~указанного.
Другими словами, требуется вывести все~пакеты, к~удалению которых приведёт удаление указанного.
Необходимо иметь возможность просмотреть как список пакетов, зависимых напрямую, 
так и список косвенно зависимых пакетов, т.~е. включая транзитивные замыкания.
Анализироваться должны только пакеты, установленные в~системе.

\item[Вывод информации о~зависимостях между репозиториями.]
Пользователь должен иметь возможность контроля 
целостности содержимого некоторого репозитория (каждый пакет может быть установлен в~систему без~подключения сторонних репозиториев)
и обнаружения необходимости   задействования пакетов из~других репозиториев. 

\end{description}

\section{Структура пакета}
\label{pkgstruct}

Описанные выше операции должны корректно обрабатывать структуру \EN{rpm}-пакетов и 
придерживаться основных принципов их~поведения во~время установки и удаления.
Информация о~версии пакета подразумевает наличие следующих компонентов:

\begin{itemize}
\item {Эпоха;}
\item{Версия;}
\item {Релиз.}
\end{itemize}

Эпоха представляет из~себя целое неотрицательное число. 
Версия и релиз могут быть произвольными наборами символов, за~исключением использования символа ``-''.
При~сравнении версии различных пакетов система должна использовать функцию \CODE{rpmRangesOverlap()} из~состава \EN{librpm}
и избегать собственной обработки. 
При~ссылке на~некоторую версию другого пакета указание эпохи и релиза необязательно,
что подразумевает их~произвольное значение.

Пакет может предоставлять функциональность других пакетов,
указывая информацию об~этом в тэге \EN{provides}.
Имя \EN{provides} допускает произвольное значение, не~обязательно совпадающее с~именем какого-либо существующего пакета
и является, скорее, соглашением, что пакет обладает некоторой совместимостью.
Для~\EN{provides}  допускается указание подмножества версии.
Неявными \EN{provides} считаются имена всех~файлов, хранимых в~пакете.

Следующие типы отношений допускаются на~множестве пакетов:

\begin{description}

\item[\EN{Requires}:]
пакет требует обязательное наличие другого пакета, указанного по~его имени или по~одному из~его \EN{provides}.
Допускается указание подмножества версии требуемого пакета.
В~случае указания ограничения версии под~\EN{requires} может подходить \EN{provides} только дополненный информацией о~версии.

\item[\EN{Conflicts}:]
пакет запрещает наличие другого пакета, указанного по~его имени или по~одному из~его \EN{provides}.
Допускается указание подмножества версии конфликтуемого пакета.
В~случае указания ограничения версии под~\EN{conflicts} может подходить \EN{provides} только дополненный информацией о~версии.

\item[\EN{Obsoletes}:]
Пакет может указывать, что является обновлением некоторого множества пакетов.
При~установке такого пакета все пакеты, обновлением которых он~является, удаляются из~ОС.
Попытка их~установки после установки обновляющего пакета приводит к~ошибки типа ``установлена более свежая версия''.
Допускается указание подмножества версии обновляемых пакетов.
В~случае указания ограничения версии под~\EN{obsoletes} может подходить \EN{provides} только дополненный информацией о~версии.

\end{description}

Установка двух пакетов является невозможной, если для~них обнаружены файловые конфликты.
Файловыми конфликтами считаются:

\begin{itemize}

\item {
хранение файлов с~одинаковыми именами, но~с~различной \EN{md5}-суммой или с~различными атрибутами 
(права доступа, идентификаторы владельца или группы, отметка времени создания);
}

\item {
хранение директорий с~одинаковыми именами, но с~разными атрибутами 
(права доступа, идентификаторы владельца или группы, отметка времени создания).
}

\end{itemize}

\section{Репозитории пакетов}

Источниками пакетов для~установки в~ОС должны служить репозитории,
размещённые на~ресурсах в~сети или на~съёмных носителях информации.
Каждый репозиторий представляет из~себя организованную специальным образом структуру директорий и файлов, содержащую:

\begin{itemize}
\item{бинарные пакеты для~установки в~ОС;}
\item{пакеты с~исходными текстами (необязательно);}
\item{вспомогательную информацию для~индексирования содержимого репозитория.}
\end{itemize}

Структура вспомогательной информации не~должна подразумевать возможность получения списка файлов в~директориях репозитория,
поскольку такая функция отсутствует в~некоторых сетевых протоколах, таких~как, например, \EN{HTTP}.
Необходимо включение дополнительной информации, позволяющей установить факт повреждения данных как в~случае 
помех при~передаче по~сетевому каналу (подсчёт \EN{md5}-сумм), 
так и~вследствии злоумышленного вторжения (электронная цифровая подпись).
Индексные данные пакетов должны содержать всю~необходимую информацию для~работы вышеописанных операций,
допуская доставку пакета на~локальный компьютер только в~случае его~установки или по~явному запросу пользователя.

Построение вспомогательной информации, предназначенной для~хранения данных о~наборе пакетов в~репозитории,
необходимо подготавливать при~помощи специальной утилиты.
Утилита должна проводить обзор множества пакетов из~указанной директории и сохранять созданные данные в~предложенном пользователем месте.
Требуется иметь возможность отбирать пакеты для~внесения в~индекс на~основе заданного регулярного выражения.

В~ходе построения вспомогательной информации файлы пакетов явно добавляются как \EN{provides}.
В~силу избыточного их~количества поведение этой функции должно ограничиваться.
Необходимо предусмотреть следующие её~режимы:

\begin{enumerate}

\item {
Регистрировать в~качестве \EN{provides} только файлы,
для~которых найдены соответствующие записи \EN{requires}, \EN{conflicts} и \EN{obsoletes}.
Такое поведение возможно, если характер репозитория подразумевает полноту множества хранимых пакетов,
 и использование других источников маловероятно.
}

\item {
Регистрация в~качестве \EN{provides} только файлов из~указанного списка директорий.
}

\item {
Регистрация всех файлов.
}

\end{enumerate}

\section{Конфигурационные возможности}

Работа операций для~манипуляции пакетами и получения информации о~них должна регулироваться набором конфигурационных файлов.
Множество конфигурационных файлов разделяется на~следующие группы:

\begin{itemize}
\item{основные конфигурационные параметры;}
\item {подключенные репозитории пакетов;}
\item {зарегистрированные ключи авторов для~проверки цифровых подписей;}
\item{необходимые конфигурационные параметры для~дополнительных возможностей, описанных в~разд.~\ref{advfeatures}.}
\end{itemize}

Желательно, чтобы параметры каждой группы были вынесены в~отдельный файл с~возможностью 
сборки его окончательного варианта на~основе фрагментов, размещённых в~отдельной директории.
Каждая утилита из~состава комплекта должна быть снабжена параметром командной строки,
указывающей положение конфигурационной информации,
а~также параметром, позволяющим выполнить чтение конфигурации и вывести его на~стандартный поток вывода (возможно, в~формате самого конфигурационного файла). 
При~пробном чтении конфигурационной информации в~выводе необходимо    отображать 
полный набор параметров, включая не~заданные пользователем в~конфигурационных файлах, с~их~значениями  по~умолчанию.

Основные параметры должны включать в~себя:

\begin{itemize}
\item {текущую архитектуру системы;}
\item {параметры загрузки файлов из~сети (прокси-сервер и~пр.);}
\item {набор опций командной строки для~каждой операции, которые должны быть неявно использованы при~всех запусках.}
\end{itemize}
