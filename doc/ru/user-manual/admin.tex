
\section{Администрирование \ds}

\ds для~правильной работы требует выполнения некоторых задач администрирования,
которые включают в~себя задачи обслуживания репозиториев пакетов 
и настройку \ds на~рабочих местах.
Утилиты, предназначенные для~администрирования репозиториев, ориентированы на~опытных пользователей,
поэтому некоторые детали реализации отличаются от~других компонентов \ds.
При~обслуживании репозиториев акцент делается на~прозрачность и гибкость выполнения запрошенных действий,
интерфейс пользователя на~национальные языки не~переводится.

\subsection{Администрирование репозиториев пакетов}

Пакеты для~установки размещаются на~узлах в~сети и передаются по~одному из~распространённых протоколов.
Файлы пакетов перед публикацией дополнительной обработки не~требуют,
но необходимо правильное именование каталогов, в~которых они сохраняются (см.~разд.~\ref{repo_format}).
Все~задачи администрирования репозиториев сводятся к~созданию и поддержке в~актуальном состоянии специальной вспомогательной информации,
называемой ``индексом  репозитория''.
Индекс используется для~хранения подробной информации о~наборе пакетов в~репозитории, 
Он доставляется  в~первую очередь  на~компьютеры пользователей,
и от~его актуальности зависит корректность обработки запросов на~внесение изменений в~состояние ОС.
В~простейшем варианте индекс хранит перечисление доступных пакетов с~необходимыми атрибутами,
включая полный список \provides, из-за чего размер файлов индекса становится чрезмерно большим.
Тем~не~менее, на~практике доля \provides, действительно задействованных в~вычислении зависимостей между пакетами, невелика,
и это даёт возможность для~различных оптимизаций размера хранимой информации.

Правильный подход настройки фильтрации \provides выбирается исходя из~назначения репозитория.
Существуют следующие режимы:

\begin{enumerate}

\item{
Фильтрация на~основе поиска соответствующих записей \requires/\conflicts.
Если репозиторий является единственным источником пакетов для~установки на~компьютеры пользователей, 
и нет других сторонних источников ПО, 
то эффективное сокращение количества \provides может быть достигнуто за~счёт включения режима фильтрации на~основе известных \requires/\conflicts.
При~активации этого режима запись \provides сохраняется в~индексе только в~том случае, если известна хотя~бы одна запись \requires или \conflicts,
в~которой имя пакета совпадает с~именем пакета в~\provides. 
Информация о~версии в~этом случае не~учитывается.
В~терминологии \ds соответствующие записи \requires/\conflicts иногда называются ``ссылками''.
}

\item {
Фильтрация на~основе каталогов файлов.
Режим фильтрации \provides на~основе информации о~каталоге файла может применяться только для тех~записей \provides,
которые были сгенерированы автоматически на~основе списка файлов пакета.
\ds имеет возможность указания списка  каталогов, файлы из~которых всегда обрабатываются как~допустимые \provides.
Эта возможность полезна для~выполнения запросов на~установку пакетов по~имени файлов.
Например, по имени файлов из~каталога \PATH{/usr/bin}.
}

\end{enumerate}

Если ни~один из~указанных режимов фильтрации \provides не~используется, то индекс содержит все возможные \provides.
Если указаны оба из~них, то в~индекс попадает \provides, если он подходит хотя~бы под одно правило.

\ds предоставляет возможность внесения изменений в~индекс без полной перегенерации,
что порождает ряд трудностей при~использовании фильтрации \provides на~основе известных \requires/\conflicts.
При~появлении новых пакетов нарушается общая целостность,
поскольку корректное добавление требует восстановления ранее исключённых \provides.
Описанные ниже утилиты позволяют правильно обновлять содержимое индекса и поддерживать его в~целостном состоянии.

\subsubsection{Общие правила использования утилит работы с~репозиторием}

Для~решения описанных задач \ds предлагает три утилиты:
\EN{ds-repo},
\EN{ds-patch} и
\EN{ds-provides},
назначение которых описывается ниже.
Для~всех них в~качестве одного из~аргументов командной строки указывается путь к~каталогу с~файлами индекса (в~выводе справки обозначен именем \CODE{INDEX\_PATH}).
Пользователь должен указать путь непосредственно к~каталогу индекса,
а не~к~каталогу репозитория,
например, \PATH{/repo/i586/base.classic}. 
Аналогично, в~каждом случае, когда требуется указание пути к~каталогу с~пакетами, необходимо указывать каталоги,
содержащие файлы пакетов без~промежуточных подкаталогов,
например, \PATH{/repo/i586/RPMS.classic}.
Несмотря на то, что набор каталогов для~организации репозитория пакетов \ds строго определён (см.~разд.~\ref{repo_format}),
для~большей гибкости  утилиты администрирования  его не~обрабатывают автоматически.
Для~всех трёх перечисленных утилит опции командной строки могут быть ключами, управляющими поведением (обычно начинаются с~одиночного или двойного дефиса), и свободными параметрами.
Для~запрета обработки опции как~ключей, т.~е. для~явного перехода к~режиму свободных параметров,
 пользователь может указать последовательность ``-~-'' (два дефиса). %%FIXME:Space between dashes;
Количество и назначение ключей и свободных параметров для~каждой утилиты требуют отдельного   описания,
но некоторые из них могут использоваться для~любой команды. 
К~ним относятся следующие ключи:

\begin{itemize}

\item {
\CODE{-h}, \CODE{-~-help} --- показать экран справки и завершить работу; %%FIXME:
}

\item {
\CODE{-~-log} --- заменить вывод информации о~статусе работы на~вывод журнала; %%FIXME:
}

\item {
\CODE{-~-debug} --- при~выводе журнала  на~стандартный вывод понизить фильтр записей до~уровня отладочной информации. %%FIXME
}

\end{itemize}

Без~использования режима вывода журнала утилиты предоставляют информацию для~пользователя о~ходе выполнения запрошенной операции.
Если утилиты были вызваны не~в~интерактивном режиме, то правильнее переключить их~вывод на~записи журнала и сохранить их в~файл. 

\subsubsection{Утилита \EN{ds-repo}}

Утилита \EN{ds-repo} выполняет все действия по~созданию индекса для~некоторой одной компоненты репозитория.
Главными параметрами для~неё являются путь к~каталогу, где должен быть расположен новый индекс,
и множество путей к~каталогам с~пакетами, которые должны быть зарегистрированы.
Целевой каталог создаётся автоматически.
Если он уже существует, то не~должен содержать других каталогов или файлов.
Каталоги с~пакетами могут быть перечислены в~произвольном порядке и могут содержать как бинарные пакеты, так и пакеты  с~исходными текстами.
Утилита \EN{ds-repo} автоматически распознает их тип и помещает в~соответствующий раздел индекса.
Имена всех описанных каталогов указываются как свободные параметры командной строки.
На~первом месте должен быть указан целевой каталог, за~которым следует перечисление каталогов с~пакетами.
Пропуск целевого каталога не~допускается. 
Если ни~один из~каталогов с~пакетами не~указан, то просматривается текущий каталог, установленный на~момент запуска утилиты.

Поведение утилиты регулируется рядом опций командной строки.
Главную роль из~них играют опции, направленные на~настройку режима фильтрации \provides, к~ним относятся:

\begin{itemize}

\item{
\CODE{-r}, \CODE{-~-references} --- включить режим фильтрации \provides на~основе известных \requires/\conflicts; %%FIXME:~;
}

\item {
\CODE{-s}, \CODE{-~-refs-sources} --- указать список дополнительных источников для~регистрации \requires/\conflicts. 
Источники перечисляются через двоеточие и отделяются от~ключа пробелом;
}

\item {
\CODE{-d}, \CODE{-~-dirs} --- включить режим фильтрации \provides на~основе каталогов файлов.
Каталоги должны быть перечислены через двоеточие и отделяются от~ключа пробелом.
}

\end{itemize}

Дополнительными источниками  для~регистрации \requires/\conflicts могут быть другие компоненты репозитория.
При~перечислении можно указывать каталоги, которые могут содержать как непосредственно файлы пакетов, так и ранее построенные индексы \ds.
Ряд ключей управляет другими деталями поведения утилиты \EN{ds-repo}. 
К~ним относятся:

\begin{itemize}

\item {
\CODE{-c}, \CODE{-~-compression} --- указывает алгоритм сжатия файлов индекса;
}

\item {
\CODE{-lb}, \CODE{-~-changelog-binary} --- включает запись в~индекс истории обновления для~бинарных пакетов;
}

\item {
\CODE{-ls}, \CODE{-~-changelog-source} --- включает запись в~индекс истории обновления для~пакетов с~исходными текстами;
}

\item {
\CODE{-nr}, \CODE{-~-no-requires} --- указывает путь к~файлу с~регулярными выражениями для~исключения записей \requires;
}

\item {
\CODE{-u}, \CODE{-~-user} --- добавляет пользовательский параметр в~информацию об~индексе.
Назначение параметра администратор репозитория может определить самостоятельно,
им может быть имя поставщика ПО, имя репозитория и~т.~д. 
Параметры указываются в~форме \CODE{имя=значение} и перечисляются через двоеточие.
}

\end{itemize}

После создания файлов индекса утилита записывает файл с~контрольными суммами.
Обратите внимание, что после работы целевой каталог содержит дополнительный файл, не~предназначенный для~загрузки пользователем.
Он содержит вспомогательную информацию, необходимую для правильной работы утилит внесения изменения в~построенный индекс.

\subsubsection{Утилита \EN{ds-patch}}

Утилита \EN{ds-patch} производит включение и исключение файлов из~построенного индекса \ds.
Все параметры, указываемые при~вызове \EN{ds-repo}, повторно перечислять не~нужно.
Они сохраняются в~информационном файле индекса репозитория и~загружаются автоматически при~изменении   его~содержимого.
При~запуске \EN{ds-patch} производится проверка контрольных сумм, и если регистрируется факт обнаружения повреждённого файла, работа завершается с~ошибкой.
После работы суммы изменённых файлов обновляются.

При~использовании утилиты \EN{ds-patch} необходимо помнить, что утилита только изменяет набор файлов, перечисленных в~индексе, но не~обрабатывает множество \provides,
которое после изменения теряет целостность и должно быть отдельно обработано утилитой \EN{ds-provides}, описанной ниже.
Целостность списка \provides нарушается не~только в~изменённом индексе, но и во~всех других взаимосвязанных компонентах репозитория.
Таким образом, для них также должна быть произведена обработка утилитой \EN{ds-provides}.

Утилита \EN{ds-patch} ожидает указания одного свободного параметра --- каталога с~индексом для~изменения.
Если он не~указан, то используется текущий каталог.
Файлы для~включения или исключения должны перечисляться после ключей \CODE{-~-add} и \CODE{-~-del} соответственно.
Файлы для~включения должны быть  перечислены с~указанием абсолютного пути к~файлу пакета, 
в~то~время как файлы для~удаления перечисляются просто по~своему имени.
Как~и~утилита \EN{ds-repo}, утилита \EN{ds-patch} производит автоматическое определение типа пакета,
и регистрирует его в~соответствующем разделе индекса.
Обратите внимание, для отделения указания целевого каталога от~предшествующего перечисления  списка файлов необходимо использовать последовательность ``-~-''.

\subsubsection{Утилита \EN{ds-provides}}

Утилита \EN{ds-provides} производит исправление множества \provides в~индексе некоторой компоненты репозитория после внесения изменений в~неё 
или в~связанные с~ней компоненты.
Производить запуск этой утилиты требуется только в~том случае, если выбран режим фильтрации \provides на~основе списка известных \requires/\conflicts.
В~качестве свободного параметра при~вызове указывается  путь к~каталогу с~файлами индекса.
Если он отсутствует, то используется текущий каталог, установленный на~момент вызова.
В~начале работы утилита \EN{ds-provides} проверяет   контрольные суммы, и если они не~совпадают, то завершает работу аварийно.
После выполнения всех необходимых действий файл с~контрольными суммами обновляется.
В~качестве дополнительного параметра может быть указан параметр \CODE{-~-ref-sources}, 
назначение которого полностью аналогично назначению одноимённого параметра для~утилиты \EN{ds-repo}.
